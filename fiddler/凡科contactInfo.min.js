$(function() {
    var e = parent.HdGame,
    t = parent.g_config,
    a = parent.gameType,
    n = [],
    i = function() {};
    _manage || (i = parent.$buryPoint.writeCommInfo(isFirstSet));
    var s = t.$$isCommLinkInfoPayGame && t.isgetself;
    t.$$curContactNoDraw = s ? t.contactNoDraw1: t.contactNoDraw,
    $("#awardUserInfoBox .awardUserInfoTitle h2").text(120 == t.style ? "活动报名": "填写" + (s ? "取货信息": t.$$linkInfoTitle)),
    $("#awardUserInfoBox .awardUserInfoTitle .tipsColor").text(s ? "为了商家发货，请先填写您的取货信息": "为了方便兑奖，请先填写您的" + t.$$linkInfoTitle),
    function() {
        $("body").append("<div id='_hdOpenIdDiv' class='hide'>" + parent.g_config.openId + "</div>");
        $(window).height();
        $("#awardUserInfoBox .awardUserInfoForm").on("touchstart", "input,textarea",
        function() {}).on("blur", "input,textarea",
        function() {
            window.scrollTo(0, 0),
            parent.scrollTo(0, 0),
            console.log("blur,input,textarea")
        }),
        t._minapp_preview && "active" === t._minapp_preview && $("#awardUserInfoBox .weui-btn-area").addClass("miniApp")
    } ();
    var o = $.parseJSON(t.$$curContactNoDraw);
    if (t.afterLinkModify && t.$$curContactNoDraw && o && "object" == typeof o[0]) {
        $(".awardUserInfoForm").empty();
        for (var l, r = !0,
        c = 0; c < o.length; c++) { (k = o[c]).isOpen && ("aadress" === k.key ? (O(k, $(".awardUserInfoForm")), r = !0) : "select" === k.type ? (M(k, $(".awardUserInfoForm")), r = !0) : (r && (l = $('<div class="weui-cells weui-cells_form"></div>'), $(".awardUserInfoForm").append(l), r = !1), "date" === k.type ? B(k, l) : R(k, l)))
        }
    }
    var d, u, p = $("#input_aphone"),
    h = $("#input_ausername"),
    f = $("#input_address"),
    v = $("#theLinkAddress"),
    w = A("afterLinkModify"),
    I = A("awardLinkMsg"),
    m = new mui.PopPicker({
        layer: 3
    });
    n.push(m);
    var g = $(".contactInput:visible").length;
    if (e.Res.load("js_city").then(function() {
        parent.site_cityUtil.getCityList().then(function() {
            var e = parent.site_cityUtil.getCityPickerData();
            if (m.setData(e), !isSetFissileInfo && (t.addressNum || t.awardAddress)) {
                var a = e,
                n = t.awardAddress.split(/,/g),
                i = t.addressNum.split(",");
                if ($.each(i,
                function(e, t) {
                    var n = 0;
                    $.each(a,
                    function(e, i) {
                        if (i.value == t) return n = e,
                        a = i.children ? i.children: [],
                        !1
                    }),
                    m.pickers[e].setSelectedIndex(n)
                }), n.length > 1) {
                    v.find(".addRessInput").val(n[0]);
                    var s = n[1].replace(/[^\x00-\xff]/g, "**").trim().length;
                    v.find(".theMaxNum").text(s),
                    v.find(".theAddresStreet").val(n[1])
                } else v.find(".theAddresStreet").val(n[0])
            }
        })
    }), !isSetFissileInfo && (h.val(t.awardUsername), p.val(t.awardPhone), t.afterLinkModify && t.$$curContactNoDraw && o && "object" == typeof o[0] && !isSetFissileInfo)) {
        var y, _ = t.userInfo;
        if (null != _) for (c = 0; c < o.length; c++) {
            var k;
            if ((k = o[c]).isOpen || -1 != k.key.indexOf("aprop")) {
                if ("aphone" == k.key) {
                    var x = _[k.key] || !t.isopenVCode;
                    $(".phoneInput").toggle(!x),
                    $(".contactInput-avcode").toggle(!x),
                    x ? (y = _[k.key], $(".contactInput-aphone").hasClass("weui-cell_vcode") && ($(".contactInput-aphone").removeClass("weui-cell_vcode"), g--)) : $(".contactInput-aphone").hasClass("weui-cell_vcode") || ($(".contactInput-aphone").addClass("weui-cell_vcode"), g++)
                }
                _[k.key] && $("#input_" + k.key).val(_[k.key])
            }
        }
        var C = $("#input_aphone").off("input.aphone");
        t.isopenVCode && 1 != t.linkInfoType && C.on("input.aphone",
        function() {
            var e = $.trim($(this).val());
            if (e = e.replace(/\s/g, ""), y && 11 == y.length && 11 == e.length) {
                var t = e == y;
                $(".phoneInput").toggle(!t),
                $(".contactInput-avcode").toggle(!t),
                t ? $(".contactInput-aphone").hasClass("weui-cell_vcode") && ($(".contactInput-aphone").removeClass("weui-cell_vcode"), g--) : $(".contactInput-aphone").hasClass("weui-cell_vcode") || ($(".contactInput-aphone").addClass("weui-cell_vcode"), g++)
            }
        })
    }
    "false" == w && ($("#awardUserInfoBox .title").text("领奖信息"), $("#awardUserInfoBox .awardTips").text(e.decodeUrl(I)));
    var b, S = $.parseJSON(t.$$curContactNoDraw);
    if (S && -1 != S[0])"number" == typeof S[0] && ($(".contactInput").hide(), $.each($.parseJSON(t.$$curContactNoDraw),
    function(e, t) {
        $(".contactInput").eq(t).show()
    }));
    else if (t.afterLinkModify || 0 != a && 4 != a && 5 != a) $("#theLinkAddress").hide();
    else if (t.wxAward) {
        var N = t.wxAward.continfo;
        if (N) {
            var P = 1 & N,
            U = 2 & N,
            T = 4 & N;
            $(".contactInput").hide(),
            P && $(".contactInput.contactInput-ausername").show(),
            U && $(".contactInput.contactInput-aphone").show(),
            T && $(".contactInput.contactInput-aadress").show()
        } else $("#theLinkAddress").hide()
    } else $(".contactInput").hide(),
    t.awardUsername && $(".contactInput.contactInput-ausername").show(),
    t.awardPhone && $(".contactInput.contactInput-aphone").show(),
    t.awardAddress && $(".contactInput.contactInput-aadress").show();
    function A(e) {
        for (var t = window.location.search.substring(1).split("&"), a = 0; a < t.length; a++) {
            var n = t[a].split("=");
            if (n[0] == e) return n[1]
        }
        return ! 1
    }
    function D(t) {
        return e.encodeHtml(t)
    }
    function F(e) {
        return !! /^1[3456789]\d{9}$/.test(e)
    }
    function L(e, a, n, i, s) {
        if (d && clearTimeout(d), $(".weui-toptips").text(a).show(), !s) {
            var o = e.parents(".contactInput");
            i && (o = e),
            o.hasClass("weui-cell_warn") || o.addClass("weui-cell_warn").find(".warnIcon").show()
        }
        parent.$(".unPublish").hide(),
        d = setTimeout(function() {
            $(".weui-toptips").hide(),
            !t.$$isLinkInfoNotPayMinApp && parent.$(".unPublish").show()
        },
        n)
    }
    function R(e, a) {
        var n, i = "aphone" == e.key && parent.g_config.isopenVCode,
        s = D(e.name),
        o = t.$$isLinkInfoNotPayMinApp && "aphone" == e.key,
        l = '<div class="weui-cell contactInput contactInput-' + e.key + " " + (i ? "weui-cell_vcode": "") + '"><div class="weui-cell__hd"><label class="weui-label">' + s + '</label></div><div class="weui-cell__bd">' + (o ? '<div class="btn_aphone">授权手机号 >></div>': '<input style="margin:0px;border: none;" type="text" id="input_' + e.key + '" class="weui-input theInputDecide textInput textInputNum" propname="' + s + '" propkey="' + e.key + '" ' + ("aphone" == e.key ? 'maxlength="11"': "") + ' placeholder="' + (e.placeholder ? (n = e.placeholder) && n.replace ? n.replace(/\"/g, "&quot;").replace(/\'/g, "&apos;") : n: "请输入" + s) + '">') + "</div>" + (i ? '<div class="weui-cell__ft phoneInput"><button id="getVCodeBtn" class="weui-vcode-btn cannotClick">获取验证码</button><div id="cannotClick" class="hasClick hide"></div></div>': '<div class="weui-cell__ft warnIcon hide"><i class="weui-icon-warn"></i></div>') + "</div>";
        i && (l += '<div class="weui-cell contactInput contactInput-avcode"><div class="weui-cell__hd"><label class="weui-label">验证码</label></div><div class="weui-cell__bd"><input style="margin:0px;border: none;" type="text" id="input_avcode" class="weui-input theInputDecide textInput" propname="验证码" propkey="avcode" placeholder="请输入验证码"></div><div class="weui-cell__ft warnIcon hide"><i class="weui-icon-warn"></i></div></div>'),
        a.append(l)
    }
    function B(e, t) {
        var a = D(e.name),
        i = D(e.placeholder),
        s = new mui.DtPicker({
            type: "date",
            beginYear: "1900",
            endYear: "2099"
        });
        n.push(s),
        t.append('<div class="weui-cell contactInput theSelected contactInput-' + e.key + '" ><div class="weui-cell__hd"><label class="weui-label">' + a + '</label></div><div class="weui-cell__bd pickerPosRel"><input id="input_' + e.key + '" class="theInputDecide weui-input ' + e.key + 'PickerInput" propkey="' + e.key + '" style="width:96%" placeholder="' + i + '" readonly="readonly"><div id="' + e.key + 'Picker" class="pickerPosAbs" ></div></div><div class="warnIcon hide"><i class="weui-icon-warn"></i></div></div>'),
        t.find("#" + e.key + "Picker").on("click",
        function() {
            $(".theInputDecide").not(".addRessInput").trigger("blur"),
            t.find("." + e.key + "PickerInput").trigger("touchend")
        }),
        t.find("." + e.key + "PickerInput").on("touchend",
        function() {
            var e = $(this);
            setInterval(function() {
                for (var e = $(".mui-pciker-list").eq(0).find("li"), t = 0, a = e.length; t < a; t++) console.log(e.eq(t).text() + " - " + e.eq(t).attr("class"))
            },
            5e3),
            j(e, s,
            function(t) {
                e.val(t.y.text + "-" + t.m.text + "-" + t.d.text);
                var a = e.parents(".theSelected");
                a.hasClass("weui-cell_warn") && a.removeClass("weui-cell_warn").find(".warnIcon").hide()
            })
        })
    }
    function M(t, a) {
        var n = D(t.name),
        i = D(t.placeholder),
        s = t.key + "Select";
        a.append('<div id="' + s + '" class="contactInput isSelect" propkey="' + t.key + '"><div class="weui-cells__title">' + n + '</div><div class="weui-cells weui-cells_form"><div class="weui-cell theSelected"><div class="weui-cell__hd"></div><div class="weui-cell__bd theSelectRelative"><input id="input_' + t.key + '" class="selectInput theInputDecide weui-input " style="width:96%" placeholder="' + i + '" readonly="readonly"><div class="theSelectAbsolute"></div></div><div class="weui-cell__ft warnIcon hide"><i class="weui-icon-warn"></i></div><input type="text" class="hide theInputForSave"></div></div></div>'),
        function(t, a) {
            var n = [];
            $.each(a.ops,
            function(t, a) {
                n.push({
                    label: e.encodeHtml(a.text),
                    value: a.value
                })
            }),
            t.on("click",
            function(i) {
                i.preventDefault(),
                V(),
                u && u.blur(),
                u = null,
                weui.picker(n, {
                    id: "select-" + a.key,
                    title: e.encodeHtml(a.name),
                    className: "custom-classname",
                    defaultValue: [n[0].value],
                    onConfirm: function(a) {
                        var n = t.parents(".theSelected");
                        n.hasClass("weui-cell_warn") && n.removeClass("weui-cell_warn").find(".warnIcon").hide(),
                        t.find(".selectInput").val(e.decodeHtml(a[0].label))
                    }
                })
            })
        } ($(a.find("#" + s + " .theSelectRelative")), t)
    }
    function O(e, a) {
        var n = D(e.placeholder);
        n = n || "请输入联系地址",
        a.append('<div class="contactInput contactInput-aadress" id="theLinkAddress"><div class="weui-cells__title">联系地址</div><div class="weui-cells weui-cells_form">' + (109 == t.style ? "": '<div class="weui-cell theSelectedCity"><div class="weui-cell__hd"><label for="" class="weui-label">省/市/区</label></div><div class="weui-cell__bd thePositonRelative"><input class="addRessInput theInputDecide weui-input " style="width:96%" placeholder="请选择地区" readonly="readonly"><div class="thePositionAbsolute"></div></div><div class="weui-cell__ft warnIcon hide"><i class="weui-icon-warn"></i></div><input type="text" class="hide theInputForSave"></div>') + '<div class="weui-cell theTargetNow"><div class="weui-cell__bd"><textarea style="padding:0;" id="input_address" class="weui-textarea theAddresStreet theInputDecide" placeholder="' + n + '" rows="3"></textarea><div class="weui-textarea-counter"><span class="theMaxNum">0</span>/200</div></div></div></div></div>'),
        a.find(".thePositionAbsolute").on("click",
        function() {
            $(".theInputDecide").not(".addRessInput").trigger("blur"),
            $(this).parents(".theSelectedCity").hasClass("weui-cell_warn") && $(this).parents(".theSelectedCity").removeClass("weui-cell_warn").find(".warnIcon").show(),
            $(".addRessInput").trigger("touchend")
        }),
        a.find(".addRessInput").on("touchend",
        function() {
            var e = $(this);
            j(e, m,
            function(t) {
                $(".theInputForSave").val((t[0] || {}).value + "," + (t[1] || {}).value + "," + (t[2] || {}).value);
                var a = "";
                t[0].text && (a += t[0].text),
                t[1].text && (a += t[1].text),
                t[2].text && (a += t[2].text),
                e.val(a)
            })
        })
    }
    function j(e, t, a) {
        V(),
        u && u.blur(),
        u = null,
        e.blur(),
        setTimeout(function() {
            t.show(a)
        },
        200)
    }
    function V() {
        n.length > 0 && $.forEach(n,
        function(e) {
            e.hide()
        })
    }
    $(".theAddresStreet").on("blur input propertychange",
    function() {
        var e = $(this).val().replace(/[^\x00-\xff]/g, "**").trim().length;
        $(this).parent().find(".theMaxNum").text(e)
    }),
    $("#input_aphone").on("input",
    function() {
        var e = $.trim($(this).val());
        F(e = e.replace(/\s/g, "")) ? $("#getVCodeBtn").removeClass("cannotClick") : $("#getVCodeBtn").addClass("cannotClick")
    }),
    $(".contactInput").click(function() {
        parent.$("#spxdPage").addClass("spxdPageHide")
    }),
    $(".theInputDecide").not(".addRessInput").on("focus",
    function(e) {
        m && m.hide(),
        V(),
        u = $(this);
        var t = $(this).parents(".contactInput");
        $(this).hasClass("theAddresStreet") && (t = $(this).parents(".theTargetNow")),
        t.hasClass("weui-cell_warn") && t.removeClass("weui-cell_warn").find(".warnIcon").hide()
    }),
    $("#getVCodeBtn").on("click",
    function() {
        if (!$(this).hasClass("cannotClick")) {
            resendTime = 60,
            $("#getVCodeBtn").hide(),
            clearInterval(b),
            b = setInterval(function() { !
                function() {
                    resendTime > 0 ? $("#cannotClick").html("重新获取(" + resendTime + ")").show() : ($("#cannotClick").hide(), $("#getVCodeBtn").show(), clearInterval(b));
                    resendTime--
                } ()
            },
            1e3);
            $("#input_avcode").val();
            var a = $("#input_aphone").val();
            $("body"); ! _manage && $.ajax({
                type: "post",
                url: t.apiAjaxUrl + "validate/checkContactSmsCount?aid=" + t.aid + "&storeId=" + t.storeId,
                error: function() {
                    e.showMsgToast("系统错误，请刷新再试！")
                },
                success: function(n) {
                    var i = $.parseJSON(n);
                    i.success ? $.ajax({
                        type: "post",
                        url: t.apiAjaxUrl + "validate/sendMobileValidateCode?aid=" + t.aid + "&gameid=" + t.gameId + "&openId=" + t.openId + "&storeId=" + t.storeId + "&tel=" + a,
                        error: function() {
                            e.showMsgToast("系统错误，请刷新再试！")
                        },
                        success: function(e) {
                            var t = $.parseJSON(e);
                            t.success ? console.log(t) : t.msg && L("", t.msg, 2e3, "", !0)
                        }
                    }) : i.msg && L("", i.msg, 2e3, "", !0)
                }
            })
        }
    }),
    $(".userSubmitBtn").on("click",
    function() {
        parent.scrollTo(0, 0),
        $("#awardUserInfoBox .awardUserInfoForm input,textarea").trigger("blur");
        var a = {
            headImg: t.headImg
        },
        n = $(".contactInput:visible");
        if (n.length != g) return L($("input.textInput"), t.$$linkInfoTitle + "未输入完整", 2e3);
        for (var s = 0; s < n.length; s++) {
            var o = $(n[s]);
            if (o.hasClass("contactInput-aadress")) {
                var l = $(".addRessInput"),
                r = $(".weui-textarea"),
                c = $.trim(l.val()) + "," + $.trim(r.val());
                if (v.is(":visible")) {
                    if (0 == $.trim(l.val()).length) return L(l.parents(".weui-cell"), "请输入联系地址", 2e3, !0);
                    if (l.parents(".theSelectedCity").removeClass("weui-cell_warn"), 0 == $.trim(r.val()).length) return L(r.parents(".weui-cell"), "请输入详细地址", 2e3, !0);
                    if (e.checkCharacterLen(200, r)) return L(r.parents(".theTargetNow"), "详细地址输入字数超出限制，请重新输入", 2e3, !0);
                    r.removeClass("weui-cell_warn")
                }
                c = c || "",
                a.aadress = c,
                a.addressNum = $.trim($(".theInputForSave").val()),
                isSetFissileInfo || (t.awardAddress = c, t.addressNum = a.addressNum)
            } else if (o.hasClass("isSelect")) {
                var d = o.find(".selectInput");
                if (0 === (I = $.trim(d.val())).length) return L(o.find(".weui-cell"), o.find(".selectInput").attr("placeholder"), 2e3, !0);
                a[o.attr("propkey")] = I
            } else if (o.hasClass("theSelected")) {
                var u = o.find(".theInputDecide"),
                p = $.trim(u.val());
                if (0 === p.length) return L(u.parents(".weui-cell"), u.attr("placeholder"), 2e3, !0);
                u.removeClass("weui-cell_warn"),
                a[u.attr("propkey")] = p
            } else {
                var w = o.find("input.textInput");
                if (w.is(":visible")) {
                    var I, m = w.attr("propkey"),
                    y = w.attr("propname");
                    if (0 == (I = (I = $.trim(w.val())) || "").length) return L(w, w.attr("placeholder"), 2e3);
                    if ("ausername" == m) {
                        if (e.checkCharacterLen(20, w)) return L(w, "姓名不能超过10个中文或20个英文字母", 2e3); ! isSetFissileInfo && (t.awardUsername = I)
                    } else if ("aphone" == m) {
                        if (!F(I = I.replace(/\s/g, ""))) return L(w, "请输入正确的号码", 2e3); ! isSetFissileInfo && (t.awardPhone = I)
                    } else if (e.checkCharacterLen(200, w)) return L(w, y + "不能超过100个中文或200个英文字母", 2e3);
                    w.removeClass("weui-cell_warn"),
                    a[m] = I
                }
            }
        }
        if (!_manage) {
            e.ajaxLoad.show();
			isFirstSet=true;//-----可以修改手机号
            var _ = t.apiAjaxUrl + "playerJoinGame/setPhone?aid=" + t.aid + "&gameId=" + t.gameId + "&openId=" + t.openId + "&canal=" + canal + "&playerOrigin=" + t.playerOrigin;
            _ += "&city_gps=" + (void 0 !== t.ipInfo.city ? e.encodeUrl(t.ipInfo.city) : "") + "&province_gps=" + (void 0 !== t.ipInfo.provice ? e.encodeUrl(t.ipInfo.provice) : "") + "&district_gps=" + (void 0 !== t.ipInfo.district ? e.encodeUrl(t.ipInfo.district) : ""),
            _ += "&isFirstSet=" + isFirstSet,
            _ += "&extra=" + t.extra,
            t.isYKY && (_ += "&ykyWXOpenId=" + t.ykyWXOpenId + "&ykyRelationId=" + t.ykyRelationId),
            isSetFissileInfo && (delete a.headImg, _ = t.apiAjaxUrl + "fissile/setFissilePlayerExInfo?gameId=" + t.gameId + "&openId=" + t.openId),
            i(),
            parent.$pushRecord && parent.$pushRecord.addContactInfo(a, JSON.parse(t.$$curContactNoDraw)),
            $.ajax({
                type: "post",
                url: _,
                data: {
                    userInfo: JSON.stringify(a)
                },
                error: function() {
                    e.ajaxLoad.hide(),
                    parent.$("#spxdPage").removeClass("spxdPageHide")
                },
                success: function(n) {
                    e.ajaxLoad.hide(),
                    e.tlog("setPhone", n);
                    var i = $.parseJSON(n);
                    if (i.success) {
                        if (setTimeout(function() {
                            parent.hg && parent.hg.fire("linkInfoCommitSuc"),
                            -1 === [120].indexOf(t.style) && e.showSuccessToast("提交成功", 400)
                        },
                        100), isSetFissileInfo) $.extend(t.fisUserInfo, a);
                        else {
                            t.ykyRelationId = i.ykyRelationId,
                            t.playerId = i.id;
                            var s = parent.$(".codeInfoBox"),
                            o = i.codeInfoList;
                            s.each(function(e) {
                                var t = parent.$(this).data("data");
                                if (t && t._awardCode) for (var a = 0; a < o.length; a++) {
                                    var n = o[a];
                                    if (n._awardCode == t._awardCode) {
                                        $.extend(t, n),
                                        o.splice(a--, 1);
                                        break
                                    }
                                }
                            }),
                            a = i.userInfo,
                            h.val(a.ausername);
                            var l = $(".textInputNum").length - 2;
                            if (l > 0) for (var r = 0; r < l; r++) $("#input_aprop" + r).val(i.userInfo["aprop" + r]);
                            f.length > 0 && f.val(i.userInfo.aadress.replace(/^[^,]*(?=,),/, "")),
                            parent.$("#awardContactInfo").show(),
                            e.updateContactView(a),
                            t.userInfo = a
                        }
                        var c = function() {
                            parent.$("#awardUserInfoBg").hide(),
                            t.$$isOpenSilkBagGray ? parent.HdgComponent.aUserInfoRef.hide(i.codeInfoList[0], a) : e.aUserInfo.hide(),
                            parent.$("#awardContactInfo").show(),
                            e.updateContactView(a),
                            t.userInfo = a,
                            setTimeout(function() {
                                parent.$("#spxdPage").removeClass("spxdPageHide")
                            },
                            2e3)
                        };
                        i.isHideName ? e.showMsgToast2({
                            bodyMsg: i.msg,
                            style: "z-index: 3000;",
                            primaryBtnFn: c
                        }) : setTimeout(c, 400)
                    } else i.data && i.data.message ? e.showMsgToast2({
                        bodyMsg: i.data.message,
                        style: "z-index: 3000;"
                    }) : i.msg ? L("", i.msg, 2e3, "", !0) : e.showMsgToast("系统错误，请刷新再试！")
                }
            })
        }
    })
});